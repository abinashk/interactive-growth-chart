<!DOCTYPE html>
<meta charset="utf-8">
<body>
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
<link href="stylesheet.css" rel="stylesheet" type="text/css">
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" charset="utf-8"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

            
<div class="container">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h2>Total Growth</h2>      
        </div>
        <div class="panel-body">
            <div id="graphic"> </div>
        </div>
    </div>
</div>

<script>

//set the margins
var margin = {top: 20, right: 150, bottom: 50, left: 50},
    width = 900 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;


// set the type of number here, n is a number with a comma, .2f will get you 2 decimal points
var NumbType = d3.format(".2f");

//color function pulls from array of colors stored in color.js
var color = d3.scale.category10();

//define the approx. number of x scale ticks
var xscaleticks = 4;

//return goal amount by today
var goalByToday = function(d){
    return NumbType(data.goal * parseDate(d.date).getDate() / new Date(parseDate(d.date).getYear(), parseDate(d.date).getMonth(), 0).getDate())
} 
               
//some date util functions
var parseDate = d3.time.format("%Y-%m-%d").parse;
var formatDate = d3.time.format("%b %d, '%y");
var getCurrentMonthMaxDay = function(){
    var today = new Date();
    var lastDayOfMonth = new Date(today.getFullYear(), today.getMonth()+1, 0).getDate();
    return lastDayOfMonth;    
}

//create an SVG
var svg = d3.select("#graphic").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");  


 //make a clip path for the graph  
 var clip = svg.append("svg:clipPath")
    .attr("id", "clip")
    .append("svg:rect")
    .attr("x", 0)
    .attr("y", 0)
    .attr("width", width)
    .attr("height", height);   

var focus = svg.append("g") 
    .style("display", "none");
       
                
//import the data
d3.json("growth_chart_data.json", function(error, json) {
    if (error) return console.warn(error);
    data = json;
    // #TODO: make this dynamic
    data['goal_growth'] = [{ "value":0, "date":"2016-05-01"}, { "value":data['goal'], "date":"2016-05-31" }]
    redraw();
});


//one function to rule them all, but this can be refactored
function redraw() { 
    
    //get color codes set for each monthlyu series
    color.domain(d3.keys(data).filter(function(key) { return (key !== "goal"); }));

    var linedata = color.domain().map(function(name) {
        return { name: name, values: data[name] };
    });

    
    //make an empty variable to stash the last values into to sort the legend
    var lastvalues=[];

    //x and y scales
    var x = d3.scale.linear()
        .domain([
        d3.min(linedata, function(c) { return d3.min(c.values, function(v) { return parseDate(v.date).getDate(); }); }),
        d3.max(linedata, function(c) { return d3.max(c.values, function(v) { return parseDate(v.date).getDate(); }); })
        ])
        .range([0, width]);

    var y = d3.scale.linear()
        .domain([
        d3.min(linedata, function(c) { return d3.min(c.values, function(v) { return v.value; }); }),
        d3.max(linedata, function(c) { return d3.max(c.values, function(v) { return v.value; }); })
        ])
        .range([height, 0]);

    //draw lines        
    var line = d3.svg.line()
        .x(function(d) { return x(parseDate(d.date).getDate()); })
        .y(function(d) { return y(d.value); });


    //create and draw the x axis
    var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom")
        .tickSize(0-height)

    
    svg.append("svg:g")
        .attr("class", "x axis");

    //create and draw the y axis                  
    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .tickSize(0-width)    
    svg.append("svg:g")
        .attr("class", "y axis");

    //bind the data
    var thegraph = svg.selectAll(".thegraph")
        .data(linedata)
 
    //append a g tag for each line and give it a unique ID based on the column name of the data     
    var thegraphEnter=thegraph.enter().append("g")
        .attr("clip-path", "url(#clip)")
        .attr("class", "thegraph")
        .attr('id',function(d){ return d.name+"-line"; })
        .style("stroke-width",2.5)


    //append the line to the graph
    thegraphEnter.append("path")
        .attr("class", "line")
        .style("stroke", function(d) { return color(d.name); })
        .attr("d", function(d) { return line(d.values[0]); })
        .transition()
        // .duration(2000)
        .attrTween('d',function (d){
            var interpolate = d3.scale.quantile()
                .domain([0,1])
                .range(d3.range(1, d.values.length+1));
            return function(t){
                return line(d.values.slice(0, interpolate(t)));
            };
        });

    //vertical line for tracking mouse hover
    focus.append("line")
        .attr("class", "x")
        .attr("x1", 0)
        .attr("y1", 0)
        .attr("x2", 0)
        .attr("y2", height)
        .attr("stroke-width", 1)
        .attr("stroke", "grey");

    //append the rectangle to capture mouse
    svg.append("rect")
        .attr("width", width)
        .attr("height", height)
        .style("fill", "none")
        .style("pointer-events", "all")
        .on("mouseover", function() { focus.style("display", null); })
        .on("mouseout", function() { focus.style("display", "none"); })
        .on("mousemove", mousemove);

    //handle mouse movement over the graph event
    function mousemove() {
        var x0 = x.invert(d3.mouse(this)[0]);
        focus.select("line.x")
            .attr("transform",
                  "translate(" + x(Math.round(x0)) + ")");
    }

    //append the legend to the graph #TODO: change its design to what's in the requirement
    var legend = svg.selectAll('.legend')
        .data(linedata);
    
    var legendEnter=legend
        .enter()
        .append('g')
        .attr('class', 'legend')
        .attr('id',function(d){ return d.name; })
        .on('click', function (d) {                            
            if($(this).css("opacity") == 1){                  

                var elemented = document.getElementById(this.id +"-line");   
                d3.select(elemented)
                    .transition()
                    // .duration(1000)
                    .style("opacity",0)
                    .style("display",'none');
            
                d3.select(this)
                    .attr('fakeclass', 'fakelegend')
                    .transition()
                    // .duration(1000)
                    .style ("opacity", .2);
            } else {
            
                var elemented = document.getElementById(this.id +"-line");
                d3.select(elemented)
                    .style("display", "block")
                    .transition()
                    // .duration(1000)
                    .style("opacity",1);
            
                d3.select(this)
                    .attr('fakeclass','legend')
                    .transition()
                    // .duration(1000)
                    .style ("opacity", 1);}
        });

    //create a scale to pass the legend items through
    var legendscale= d3.scale.ordinal()
                .domain(lastvalues)
                .range([0,30,60,90,120,150,180,210]);

    //add the circles to the created legend container
    legendEnter.append('circle')
        .attr('cx', width +20)
        .attr('cy', function(d){return legendscale(d.values[d.values.length-1].value);})
        .attr('r', 7)
        .style('fill', function(d) { 
            return color(d.name);
        });
                        
    //add the legend text
    legendEnter.append('text')
        .attr('x', width+35)
        .attr('y', function(d){return legendscale(d.values[d.values.length-1].value);})
        .text(function(d){ return d.name; });

    //set variable for updating the graph
    var thegraphUpdate = d3.transition(thegraph);
    
    //change values of path and then the circles to those of the new series
    thegraphUpdate.select("path")
        .attr("d", function(d, i) {       
      
            lastvalues[i]=d.values[d.values.length-1].value;         
            lastvalues.sort(function (a,b){return b-a});
            legendscale.domain(lastvalues);
        
            return line(d.values); });

      //for legend items
      var legendUpdate=d3.transition(legend);
      
    legendUpdate.select("circle")
        .attr('cy', function(d, i){  
            return legendscale(d.values[d.values.length-1].value);});

    legendUpdate.select("text")
        .attr('y',  function (d) {return legendscale(d.values[d.values.length-1].value);});


     //update the axes  
    d3.transition(svg).select(".y.axis")
        .call(yAxis);   
          
    d3.transition(svg).select(".x.axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

//end of the redraw function
}
    
</script>    
</body>

